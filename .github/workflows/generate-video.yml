name: Generate Reddit Video

on:
  # Run twice daily (at 8:00 and 20:00 UTC)
  schedule:
    - cron: '0 8 * * *'
    - cron: '0 20 * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      upload:
        description: 'Upload to YouTube'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      privacy:
        description: 'YouTube privacy setting'
        required: false
        default: 'public'
        type: choice
        options:
          - public
          - private
          - unlisted

env:
  REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
  REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
  YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
  YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
  YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true  # For large background video files

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

          # Fix ImageMagick policy for MoviePy
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml || true

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore history cache
        uses: actions/cache@v4
        with:
          path: output/history.json
          key: video-history-${{ github.run_number }}
          restore-keys: |
            video-history-

      - name: Check assets
        run: |
          echo "Checking required assets..."

          # Check for background videos
          if [ -z "$(ls -A assets/backgrounds/*.mp4 2>/dev/null)" ]; then
            echo "âš ï¸ WARNING: No background videos found in assets/backgrounds/"
            echo "Please add .mp4 files (Minecraft parkour, Subway Surfer, etc.)"
            exit 1
          fi

          echo "âœ… Background videos found:"
          ls -la assets/backgrounds/

          # Check for sound effects (optional)
          if [ -z "$(ls -A assets/sounds/punchline/*.mp3 2>/dev/null)" ]; then
            echo "â„¹ï¸ No punchline sound effects found (optional)"
          else
            echo "âœ… Sound effects found:"
            ls -la assets/sounds/punchline/
          fi

      - name: Generate video
        id: generate
        run: |
          cd src

          # Determine upload flag
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            UPLOAD_FLAG=${{ github.event.inputs.upload }}
            PRIVACY=${{ github.event.inputs.privacy }}
          else
            UPLOAD_FLAG="true"
            PRIVACY="public"
          fi

          # Run generator
          if [ "$UPLOAD_FLAG" = "false" ]; then
            python main.py --no-upload
          else
            python main.py --privacy $PRIVACY
          fi

      - name: Save history cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: output/history.json
          key: video-history-${{ github.run_number }}

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-video-${{ github.run_number }}
          path: output/videos/*.mp4
          retention-days: 7

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: logs-${{ github.run_number }}
          path: |
            output/audio/*.json
            output/history.json
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“¹ Video Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f output/videos/*.mp4 ]; then
            echo "âœ… Video generated successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Generated Files:" >> $GITHUB_STEP_SUMMARY
            ls -la output/videos/*.mp4 >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No video was generated" >> $GITHUB_STEP_SUMMARY
          fi
