name: Generate Reddit Video

on:
  # Run twice daily (at 8:00 and 20:00 UTC)
  schedule:
    - cron: '0 8 * * *'
    - cron: '0 20 * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      upload:
        description: 'Upload to YouTube'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      privacy:
        description: 'YouTube privacy setting'
        required: false
        default: 'public'
        type: choice
        options:
          - public
          - private
          - unlisted

env:
  # Only YouTube credentials needed (Reddit uses public JSON endpoints)
  YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
  YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
  YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: |
          git lfs install
          git lfs pull
          echo "LFS files pulled"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

          # Fix ImageMagick policy for MoviePy
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml || true

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore history cache
        uses: actions/cache@v4
        with:
          path: output/history.json
          key: video-history-${{ github.run_number }}
          restore-keys: |
            video-history-

      - name: Check assets
        run: |
          echo "=== Checking assets ==="
          echo ""
          echo "ðŸ“ assets/backgrounds/ contents:"
          ls -la assets/backgrounds/ || echo "Directory not found"
          echo ""
          echo "ðŸ“ Checking for .mp4 files:"
          find assets/backgrounds -name "*.mp4" -type f 2>/dev/null || echo "No .mp4 files found"
          echo ""

          # Check file sizes (LFS pointers are small ~130 bytes)
          echo "ðŸ“Š File sizes:"
          for f in assets/backgrounds/*.mp4 2>/dev/null; do
            if [ -f "$f" ]; then
              size=$(stat -f%z "$f" 2>/dev/null || stat -c%s "$f" 2>/dev/null)
              echo "  $f: $size bytes"
              if [ "$size" -lt 1000 ]; then
                echo "    âš ï¸ WARNING: File too small, might be LFS pointer!"
              fi
            fi
          done
          echo ""

          # Verify at least one valid video exists
          valid_video=false
          for f in assets/backgrounds/*.mp4 2>/dev/null; do
            if [ -f "$f" ]; then
              size=$(stat -f%z "$f" 2>/dev/null || stat -c%s "$f" 2>/dev/null)
              if [ "$size" -gt 10000 ]; then
                valid_video=true
                echo "âœ… Valid video found: $f"
                break
              fi
            fi
          done

          if [ "$valid_video" = false ]; then
            echo "âŒ ERROR: No valid background videos found!"
            echo "Please ensure .mp4 files are properly uploaded with Git LFS"
            exit 1
          fi

      - name: Generate video
        id: generate
        run: |
          cd src

          # Determine upload flag
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            UPLOAD_FLAG=${{ github.event.inputs.upload }}
            PRIVACY=${{ github.event.inputs.privacy }}
          else
            UPLOAD_FLAG="true"
            PRIVACY="public"
          fi

          # Run generator
          if [ "$UPLOAD_FLAG" = "false" ]; then
            python main.py --no-upload
          else
            python main.py --privacy $PRIVACY
          fi

      - name: Save history cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: output/history.json
          key: video-history-${{ github.run_number }}

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-video-${{ github.run_number }}
          path: output/videos/*.mp4
          retention-days: 7

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: logs-${{ github.run_number }}
          path: |
            output/audio/*.json
            output/history.json
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“¹ Video Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f output/videos/*.mp4 ]; then
            echo "âœ… Video generated successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Generated Files:" >> $GITHUB_STEP_SUMMARY
            ls -la output/videos/*.mp4 >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No video was generated" >> $GITHUB_STEP_SUMMARY
          fi
