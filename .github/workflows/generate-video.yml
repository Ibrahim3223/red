name: Generate Reddit Video

on:
  # Run twice daily (at 8:00 and 20:00 UTC)
  schedule:
    - cron: '0 8 * * *'
    - cron: '0 20 * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      upload:
        description: 'Upload to YouTube'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      privacy:
        description: 'YouTube privacy setting'
        required: false
        default: 'public'
        type: choice
        options:
          - public
          - private
          - unlisted

env:
  # YouTube credentials
  YOUTUBE_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
  YOUTUBE_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
  YOUTUBE_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
  # Groq API for AI-generated titles
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

jobs:
  generate-video:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: |
          git lfs install
          git lfs pull
          echo "LFS files pulled"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

          # Fix ImageMagick policy for MoviePy
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml || true

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore history cache
        uses: actions/cache@v4
        with:
          path: output/history.json
          key: video-history-${{ github.run_number }}
          restore-keys: |
            video-history-

      - name: Check assets
        run: |
          echo "=== Checking assets ==="
          echo "ðŸ“ assets/backgrounds/ contents:"
          ls -la assets/backgrounds/

          # Count valid mp4 files (larger than 10KB)
          valid_count=$(find assets/backgrounds -name "*.mp4" -type f -size +10k 2>/dev/null | wc -l)
          echo "âœ… Found $valid_count valid video file(s)"

          if [ "$valid_count" -eq 0 ]; then
            echo "âŒ ERROR: No valid background videos found!"
            exit 1
          fi

      - name: Generate video
        id: generate
        run: |
          cd src

          # Determine upload flag
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            UPLOAD_FLAG=${{ github.event.inputs.upload }}
            PRIVACY=${{ github.event.inputs.privacy }}
          else
            UPLOAD_FLAG="true"
            PRIVACY="public"
          fi

          # Run generator
          if [ "$UPLOAD_FLAG" = "false" ]; then
            python main.py --no-upload
          else
            python main.py --privacy $PRIVACY
          fi

      - name: Save history cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: output/history.json
          key: video-history-${{ github.run_number }}

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-video-${{ github.run_number }}
          path: output/videos/*.mp4
          retention-days: 7

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: logs-${{ github.run_number }}
          path: |
            output/audio/*.json
            output/history.json
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“¹ Video Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f output/videos/*.mp4 ]; then
            echo "âœ… Video generated successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Generated Files:" >> $GITHUB_STEP_SUMMARY
            ls -la output/videos/*.mp4 >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No video was generated" >> $GITHUB_STEP_SUMMARY
          fi
